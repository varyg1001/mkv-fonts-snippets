#!/bin/bash

fontadd(){
local finput OPTION s font ex count sz l cou help
help='Usage: fontadd [-f fonts folder/path] video input (*.mkv)'
if [[ $# -eq 0 ]]; then echo "$help";return 1;fi
while getopts ':hf:' OPTION; do
	case "$OPTION" in
      h) echo "$help"; return 0;;
      f) finput=$OPTARG;;
      *) echo "ERROR: Invalid option: -$OPTARG" >&2; return 1;;
    esac
done;shift "$((OPTIND - 1))"
if [[ ! -d "$finput" ]]; then echo "The fonts directory doesn't exist"; return 1; fi
echo "$finput"
for s in "$@"; do 
	if [[ ! -f "$s" ]]; then echo "The video file doesn't exist"; return 1; fi
	l='0';sz='0'
	if [[ "$s" != *mkv ]]
	then continue;fi
	echo "$s"
    font=$(printf '%s\n' "$finput/"* | grep -e ttf -e otf -e OTF -e TTF) && count=$(echo "$font" | wc -l)
    ex=$(mkvmerge --identify  "$s" | grep -o "file name.*" | cut -c12- | rev | cut -c2- | rev | grep -i -e .ttf -e .otf) && cou=$(echo "$ex" | wc -l)
	for f in $( eval echo {1..$count}); do 
		if [[ "$ex" =~ $(echo "$font" | sed -n "$f"p | sed "s|"$finput"/||g") ]]; 
		then (( l++ ))
		else (( sz++ )); mkvpropedit "$s" --add-attachment "$(echo "$font" | sed -n "$f"p)" >/dev/null 2>&1
		printf '\r[%s/%s] fonts added' "$sz" "$count";fi
    done
    printf '\r[%s/%s] fonts added\n%s font(s) exist in the file' "$sz" "$count" "$l";
done
}

fontext(){
local help output OPTARG f x font p vfont sz l k
help=$(cat <<'EOF'
Usage:
fontext [options] [input(s)]
Examples:
fontext input.mkv
fontext *mkv
fontext -o newfonts input.mkv
Options:
-o [fonts output folder]       Sets the fonts output folder.
(default: fonts/)
EOF
  )
if [[ $# -eq 0 ]]; then
echo "$help";return 1;fi
while getopts ':ho:' OPTION; do
    case "$OPTION" in
      h) echo "$help"; return 0;;
      o) output=$OPTARG;;
      *) echo "ERROR: Invalid option: -$OPTARG" >&2; return 1;;
	esac
done;shift "$((OPTIND - 1))"
if [[ -z "$output" ]]; then p="fonts"
	else p="$output"; fi
for f in "$@"; do
	k='0';sz='0'
	if [[ "$f" != *mkv ]];then continue; fi
	vfont=$(mkvmerge --identify "$f" | grep -o "file name.*" | cut -c12- | rev | cut -c2- | rev | grep -i -e .ttf -e .otf)
	l=$(echo "$vfont" | wc -l)
	echo "$f"
	for x in $( eval echo {1..$l} ); do
		font=$(echo "$vfont" | sed -n "$x"p)
		if [ -f "$p"/"$font" ]; then (( k++ ))
		else mkvextract "$f" attachments "$x":"$p"/"$font" >/dev/null 2>&1
		(( sz++ ));fi
	done
	printf '%s extracted fonts\n%s already exist in the folder\n\n' "$sz" "$k"
done
}
